<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Custom Estimators • tfestimators</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">tfestimators</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Using
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Getting Started</li>
    <li>
      <a href="../articles/using_estimators.html">Using Estimators</a>
    </li>
    <li>
      <a href="../articles/input_functions.html">Input Functions</a>
    </li>
    <li>
      <a href="../articles/feature_columns.html">Feature Columns</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Canned Estimators</li>
    <li>
      <a href="../articles/linear_estimators.html">Linear Models</a>
    </li>
    <li>
      <a href="../articles/linear_dnn_combined_estimators.html">Linear/DNN Models</a>
    </li>
    <li>
      <a href="../articles/support_vector_machines.html">Support Vector Machines</a>
    </li>
    <li>
      <a href="../articles/recurrent_neural_networks.html">Recurrent Neural Networks</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Advanced</li>
    <li>
      <a href="../articles/experiments.html">Experiments</a>
    </li>
    <li>
      <a href="../articles/run_hooks.html">Run Hooks</a>
    </li>
    <li>
      <a href="../articles/run_configuration.html">Run Configuration</a>
    </li>
    <li>
      <a href="../articles/custom_estimators.html">Custom Estimators</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/deployment.html">Deployment</a>
</li>
<li>
  <a href="../articles/examples/index.html">Examples</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/tfestimators">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Custom Estimators</h1>
            
          </div>

    
    
<div class="contents">
<p>Users can also implement their own custom Estimator by configuring the layers and architecture of the Estimator. The Estimator’s architecture is configured using a user-defined <code>model_fn</code>, a function which builds a TensorFlow graph and returns necessary information to train a model, evaluate it, and predict with it. Users writing custom estimators to implement custom model architecture only have to implement this function to specify the layers of the custom Estimator. It is possible, and in fact, common, that <code>model_fn</code> contains regular TensorFlow without using any other part of our framework. It is often the case because existing models are being adapted or converted to be implemented in terms of an estimator.</p>
<p>Users define the model architecture in a custom model function <code>custom_model_fn</code> that contains the following arguments in the signature that users can grab to define customized handling conditionally:</p>
<ul>
<li>features and labels of the model.</li>
<li>mode that contains the different modes of a model, such as training, inference, or evaluation.</li>
<li>params that contains the tuning parameters in a model.</li>
<li>config that represents the <code>RunConfig</code> objects used in a model, including GPU percentages, cluster information, etc.</li>
</ul>
<p>The <code>custom_model_fn()</code> function should return an <code><a href="../reference/estimator_spec.html">estimator_spec(predictions, loss, train_op, mode)</a></code> that contains the predictions, losses, training op, and mode.</p>
<p>The following example demonstrates the construction and fitting of a custom estimator that has custom architectures.</p>
<p>Firstly, let’s define the input using <code><a href="../reference/input_fn.html">input_fn()</a></code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">constructed_input_fn &lt;-<span class="st"> </span><span class="kw"><a href="../reference/input_fn.html">input_fn</a></span>(
    <span class="dt">object =</span> iris,
    <span class="dt">response =</span> <span class="st">"Species"</span>,
    <span class="dt">features =</span> <span class="kw">c</span>(
      <span class="st">"Sepal.Length"</span>,
      <span class="st">"Sepal.Width"</span>,
      <span class="st">"Petal.Length"</span>,
      <span class="st">"Petal.Width"</span>),
    <span class="dt">batch_size =</span> 10L
)</code></pre></div>
<p>Next, we define the custom model function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
custom_model_fn &lt;-<span class="st"> </span><span class="cf">function</span>(features, labels, mode, params, config) {
      <span class="co"># Create three fully connected layers respectively of size 10, 20, and 10 with</span>
    <span class="co"># each layer having a dropout probability of 0.1.</span>
    logits &lt;-<span class="st"> </span>features <span class="op">%&gt;%</span>
<span class="st">      </span>tf<span class="op">$</span>contrib<span class="op">$</span>layers<span class="op">$</span><span class="kw">stack</span>(
        tf<span class="op">$</span>contrib<span class="op">$</span>layers<span class="op">$</span>fully_connected, <span class="kw">c</span>(10L, 20L, 10L),
        <span class="dt">normalizer_fn =</span> tf<span class="op">$</span>contrib<span class="op">$</span>layers<span class="op">$</span>dropout,
        <span class="dt">normalizer_params =</span> <span class="kw">list</span>(<span class="dt">keep_prob =</span> <span class="fl">0.9</span>)) <span class="op">%&gt;%</span>
<span class="st">      </span>tf<span class="op">$</span>contrib<span class="op">$</span>layers<span class="op">$</span><span class="kw">fully_connected</span>(3L, <span class="dt">activation_fn =</span> <span class="ot">NULL</span>) <span class="co"># Compute logits (1 per class) and compute loss.</span>
    
    predictions &lt;-<span class="st"> </span><span class="kw">list</span>(
      <span class="dt">class =</span> tf<span class="op">$</span><span class="kw">argmax</span>(logits, 1L),
      <span class="dt">prob =</span> tf<span class="op">$</span>nn<span class="op">$</span><span class="kw">softmax</span>(logits))
    
    <span class="co"># Return estimator_spec early with NULL loss and train_op during inference mode</span>
    <span class="cf">if</span>(mode <span class="op">==</span><span class="st"> "infer"</span>){
      <span class="kw">return</span>(<span class="kw"><a href="../reference/estimator_spec.html">estimator_spec</a></span>(
      <span class="dt">mode =</span> mode, <span class="dt">predictions =</span> predictions, <span class="dt">loss =</span> <span class="ot">NULL</span>, <span class="dt">train_op =</span> <span class="ot">NULL</span>))
    }
    
    labels &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">one_hot</span>(labels, 3L)
    loss &lt;-<span class="st"> </span>tf<span class="op">$</span>losses<span class="op">$</span><span class="kw">softmax_cross_entropy</span>(labels, logits)
    
    <span class="co"># Create a tensor for training op.</span>
    train_op &lt;-<span class="st"> </span>tf<span class="op">$</span>contrib<span class="op">$</span>layers<span class="op">$</span><span class="kw">optimize_loss</span>(
      loss,
      tf<span class="op">$</span>contrib<span class="op">$</span>framework<span class="op">$</span><span class="kw">get_global_step</span>(),
      <span class="dt">optimizer =</span> <span class="st">'Adagrad'</span>,
      <span class="dt">learning_rate =</span> <span class="fl">0.1</span>)
    
    <span class="kw">return</span>(<span class="kw"><a href="../reference/estimator_spec.html">estimator_spec</a></span>(<span class="dt">mode =</span> mode, <span class="dt">predictions =</span> predictions, <span class="dt">loss =</span> loss, <span class="dt">train_op =</span> train_op))
}

<span class="co"># Initialize and fit the model using the the custom model function we defined</span>
<span class="co"># and the constructed_input_fn that represents the input data source.  </span>
classifier &lt;-<span class="st"> </span><span class="kw"><a href="../reference/estimator.html">estimator</a></span>(<span class="dt">model_fn =</span> custom_model_fn)
classifier &lt;-<span class="st"> </span><span class="kw">train</span>(classifier, <span class="dt">input_fn =</span> constructed_input_fn, <span class="dt">steps =</span> 2L)</code></pre></div>
<p>Note that the above code contains a lot of <code>$</code>s. It is unnecessary to create wrapper APIs for every methods that users might use, e.g. <code>tf$contrib$layers$optimize_loss</code>, since custom models are designed to be flexible and extensible so users can insert any arbitrary low level TensorFlow APIs.</p>
<p>Users can then supply new data in <code>input_fn</code> to <code>predict()</code> and make predictions using the trained model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predictions &lt;-<span class="st"> </span><span class="kw">predict</span>(classifier, <span class="dt">input_fn =</span> constructed_input_fn)</code></pre></div>
<p>Since our predictions is defined as a list of two named items in the custom model function like follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predictions &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">class =</span> tf<span class="op">$</span><span class="kw">argmax</span>(logits, 1L),
  <span class="dt">prob =</span> tf<span class="op">$</span>nn<span class="op">$</span><span class="kw">softmax</span>(logits))</code></pre></div>
<p>we can then loop through each prediction and collect the predicted classes and probabilities like the following:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># extract predicted classes</span>
predicted_classes &lt;-<span class="st"> </span><span class="kw">lapply</span>(predictions, <span class="cf">function</span>(prediction) prediction<span class="op">$</span>class)

<span class="co"># extract the raw probabilities for each new row of data and for each class</span>
predicted_raw_probs &lt;-<span class="st"> </span><span class="kw">lapply</span>(predictions, <span class="cf">function</span>(prediction) prediction<span class="op">$</span>prob)</code></pre></div>
<p>Users can also pass <code>model_dir</code> which is the directory to save model parameters, graph and etc. This can also be used to load checkpoints from the directory into a estimator to continue training a previously saved model. Users can also pass a <code>config</code> to canned Estimator or custom Estimator that specify the model run-time configuration, such as cluster information, GPU fractions, etc.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Yuan Tang, JJ Allaire, <a href="https://www.rstudio.com"><img src="http://tidyverse.org/rstudio-logo.svg" height="24"></a>, Kevin Ushey.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
