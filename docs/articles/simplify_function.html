<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simplify Function • tfestimators</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">tfestimators</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Using
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Getting Started</li>
    <li>
      <a href="../articles/estimator_basics.html">Estimator Basics</a>
    </li>
    <li>
      <a href="../articles/input_functions.html">Input Functions</a>
    </li>
    <li>
      <a href="../articles/feature_columns.html">Feature Columns</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Advanced</li>
    <li>
      <a href="../articles/run_hooks.html">Run Hooks</a>
    </li>
    <li>
      <a href="../articles/creating_estimators.html">Custom Estimators</a>
    </li>
    <li>
      <a href="../articles/simplify_function.html">Simplify Function</a>
    </li>
    <li>
      <a href="../articles/layers.html">TensorFlow Layers</a>
    </li>
    <li>
      <a href="../articles/tensorboard.html">TensorBoard Visualization</a>
    </li>
    <li>
      <a href="../articles/parsing_spec.html">Parsing Utilities</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/examples/index.html">Examples</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/tfestimators">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Simplify Function</h1>
            
          </div>

    
    
<div class="contents">
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>Estimator’s <code>predict()</code> and <code><a href="http://www.rdocumentation.org/packages/tensorflow/topics/evaluate">evaluate()</a></code> provide an easy and efficient way of making predictions and evaluations on new data. However, the prediction and evaluation results are pretty verbose and usually in forms of nested lists, which isn’t user-friendly. By default, the results produced from canned estimators will be simplified using a default simplify function for both <code>predict()</code> and <code><a href="http://www.rdocumentation.org/packages/tensorflow/topics/evaluate">evaluate()</a></code>. You can also write a custom simplify function to them. Custom estimators do not simplify results by default unless you provide a custom simplify function. In this tutorial, we’ll illustrate how the simplified results look like and how you can write your own simplify function.</p>
</div>
<div id="simplify-prediction-results" class="section level2">
<h2 class="hasAnchor">
<a href="#simplify-prediction-results" class="anchor"></a>Simplify Prediction Results</h2>
<p>First of all, let’s define our feature columns, input function, and a basic linear classifier:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tfestimators)

cols &lt;-<span class="st"> </span><span class="kw"><a href="../reference/feature_columns.html">feature_columns</a></span>( 
  <span class="kw"><a href="../reference/column_numeric.html">column_numeric</a></span>(<span class="st">"disp"</span>, <span class="st">"cyl"</span>)
)

mtcars_input_fn &lt;-<span class="st"> </span><span class="cf">function</span>(data) {
  <span class="kw"><a href="../reference/input_fn.html">input_fn</a></span>(data, 
           <span class="dt">features =</span> <span class="kw">c</span>(<span class="st">"disp"</span>, <span class="st">"cyl"</span>), 
           <span class="dt">response =</span> <span class="st">"vs"</span>)
}

indices &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(mtcars), <span class="dt">size =</span> <span class="fl">0.80</span> <span class="op">*</span><span class="st"> </span><span class="kw">nrow</span>(mtcars))
train_data &lt;-<span class="st"> </span>mtcars[indices, ]
test_data  &lt;-<span class="st"> </span>mtcars[<span class="op">-</span>indices, ]

model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/linear_estimators.html">linear_classifier</a></span>(<span class="dt">feature_columns =</span> cols)</code></pre></div>
<p>and we train the model using the input function constructed from training data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tensorflow/topics/train">train</a></span>(<span class="kw">mtcars_input_fn</span>(train_data))</code></pre></div>
<pre><code>[-] Training -- loss: 17.33, step: 1 </code></pre>
<p>Here’s what the prediction output looks like without applying the simplifier on the results:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(<span class="kw">mtcars_input_fn</span>(mtcars[<span class="dv">1</span>, ]), <span class="dt">simplify =</span> <span class="ot">FALSE</span>)</code></pre></div>
<pre><code>[[1]]
[[1]]$probabilities
[1] 1.000000e+00 3.221593e-15

[[1]]$logits
[1] -33.3689

[[1]]$classes
[1] "0"

[[1]]$class_ids
[1] 0

[[1]]$logistic
[1] 3.221593e-15
</code></pre>
<div id="default-simplifier" class="section level3">
<h3 class="hasAnchor">
<a href="#default-simplifier" class="anchor"></a>Default Simplifier</h3>
<p>If <code>simplify = TRUE</code>, a default simplify function for predictions will be used to flatten the results so they are more appealing and concise like the following:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(<span class="kw">mtcars_input_fn</span>(test_data), <span class="dt">simplify =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code># A tibble: 7 x 5
  probabilities    logits classes class_ids     logistic
          &lt;dbl&gt;     &lt;dbl&gt;   &lt;chr&gt;     &lt;dbl&gt;        &lt;dbl&gt;
1             1 -73.76886       0         0 9.174686e-33
2             1 -73.76886       0         0 9.174686e-33
3             1 -34.88890       0         0 7.046004e-16
4             1 -65.36886       0         0 4.080051e-29
5             1 -62.56886       0         0 6.709519e-28
6             1 -25.02895       0         0 1.349171e-11
7             1 -25.16895       0         0 1.172913e-11</code></pre>
<p>Note that this time we use the full test dataset since no matter how large the prediction results are, we can still see the results in a concise <a href="http://tibble.tidyverse.org/index.html">tibble object</a>.</p>
</div>
<div id="custom-simplifier-for-prediction-result" class="section level3">
<h3 class="hasAnchor">
<a href="#custom-simplifier-for-prediction-result" class="anchor"></a>Custom Simplifier for Prediction Result</h3>
<p>You can also write your own custom simplify function to clean up prediction results. For example, below we define a custom function that obtains the probabilities from the list of prediction results with keys being the prediction keys pre-defined for this canned estimator. In this case, <code>linear_classifier</code> has logits, probabilities, prediction classes, logistics, etc. pre-defined. We can see a full list of available predictions keys by calling <code><a href="../reference/prediction_keys.html">prediction_keys()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">simplify_fn &lt;-<span class="st"> </span><span class="cf">function</span>(predictions) {
  <span class="kw">lapply</span>(predictions, <span class="cf">function</span>(x) x<span class="op">$</span>probabilities)
}

model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">predict</span>(<span class="kw">mtcars_input_fn</span>(mtcars[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, ]), <span class="dt">simplify =</span> simplify_fn)</code></pre></div>
<pre><code>[[1]]
[1] 1.000000e+00 3.221593e-15

[[2]]
[1] 1.000000e+00 3.221593e-15</code></pre>
</div>
</div>
<div id="simplify-evaluation-results" class="section level2">
<h2 class="hasAnchor">
<a href="#simplify-evaluation-results" class="anchor"></a>Simplify Evaluation Results</h2>
<p>Evaluation results can also be simplified. Here’s what the raw evaluation results look like without simplification by providing <code>simplify = FALSE</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tensorflow/topics/evaluate">evaluate</a></span>(<span class="kw">mtcars_input_fn</span>(mtcars[<span class="dv">1</span>, ]), <span class="dt">simplify =</span> <span class="ot">FALSE</span>)</code></pre></div>
<pre><code>$loss
[1] 3.221593e-15

$accuracy_baseline
[1] 1

$global_step
[1] 1

$auc
[1] 0.999999

$`prediction/mean`
[1] 3.221593e-15

$`label/mean`
[1] 0

$average_loss
[1] 3.221593e-15

$auc_precision_recall
[1] 0

$accuracy
[1] 1</code></pre>
<p>It contains a list of evaluation results for the metrics pre-defined for this particular canned estimator, such as accuracy, average loss, AUC, etc. The evaluation result is pretty verbose without simplification.</p>
<div id="default-simplifier-1" class="section level3">
<h3 class="hasAnchor">
<a href="#default-simplifier-1" class="anchor"></a>Default Simplifier</h3>
<p>Now let’s take a look at the simplified results by providing <code>simplify = TRUE</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tensorflow/topics/evaluate">evaluate</a></span>(<span class="kw">mtcars_input_fn</span>(test_data), <span class="dt">simplify =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>Observations: 1
Variables: 9
$ loss                 &lt;dbl&gt; 60.05785
$ accuracy_baseline    &lt;dbl&gt; 0.7142857
$ global_step          &lt;dbl&gt; 1
$ auc                  &lt;dbl&gt; 0.5000001
$ `prediction/mean`    &lt;dbl&gt; 3.603078e-12
$ `label/mean`         &lt;dbl&gt; 0.2857143
$ average_loss         &lt;dbl&gt; 8.579692
$ auc_precision_recall &lt;dbl&gt; 0.6428569
$ accuracy             &lt;dbl&gt; 0.7142857</code></pre>
<p>The evaluation results now look compact.</p>
</div>
<div id="custom-simplifier-for-evaluation-result" class="section level3">
<h3 class="hasAnchor">
<a href="#custom-simplifier-for-evaluation-result" class="anchor"></a>Custom Simplifier for Evaluation Result</h3>
<p>We can also apply a custom simplifier on the evaluation result like the following to obtain the AUC score:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">simplify_fn &lt;-<span class="st"> </span><span class="cf">function</span>(results) {
  results<span class="op">$</span>auc 
}

model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tensorflow/topics/evaluate">evaluate</a></span>(<span class="kw">mtcars_input_fn</span>(test_data), <span class="dt">simplify =</span> simplify_fn)</code></pre></div>
<pre><code>[1] 0.5000001</code></pre>
</div>
</div>
<div id="writing-simplify-function-for-custom-estimators" class="section level2">
<h2 class="hasAnchor">
<a href="#writing-simplify-function-for-custom-estimators" class="anchor"></a>Writing Simplify Function for Custom Estimators</h2>
<p>So far we’ve only illustrated how to simplify the results for canned estimators, in particular, <code>linear_classifier</code>. Custom estimators do not simplify results by default unless you provide a custom simplify function. The way to write them is almost identical to canned estimators. The predictions and evaluations results are highly dependent on what’s defined in the <code>model_fn</code> so you need to pay attention to them when writing the simplify function.</p>
<p>For example, below is a snippet in the <code>model_fn</code> that defines the behavior for prediction mode (note the <code>mode == "infer"</code>). <code>predictions</code> is being returned during this phase and is a list of keyed items for raw prediction classes and probabilities.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predictions &lt;-<span class="st"> </span><span class="kw">list</span>(
    <span class="dt">class =</span> tf<span class="op">$</span><span class="kw">argmax</span>(logits, 1L),
    <span class="dt">prob =</span> tf<span class="op">$</span>nn<span class="op">$</span><span class="kw">softmax</span>(logits))
<span class="cf">if</span> (mode <span class="op">==</span><span class="st"> "infer"</span>) {
    <span class="kw">return</span>(<span class="kw"><a href="../reference/estimator_spec.html">estimator_spec</a></span>(<span class="dt">mode =</span> mode, <span class="dt">predictions =</span> predictions, <span class="dt">loss =</span> <span class="ot">NULL</span>, <span class="dt">train_op =</span> <span class="ot">NULL</span>))
}</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#simplify-prediction-results">Simplify Prediction Results</a></li>
      <li><a href="#simplify-evaluation-results">Simplify Evaluation Results</a></li>
      <li><a href="#writing-simplify-function-for-custom-estimators">Writing Simplify Function for Custom Estimators</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Yuan Tang, JJ Allaire, Kevin Ushey, <a href="https://www.rstudio.com"><img src="http://tidyverse.org/rstudio-logo.svg" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
