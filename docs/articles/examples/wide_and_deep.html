<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>wide_and_deep.R • tfestimators</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../jquery.sticky-kit.min.js"></script><script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<script src="../../extra.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../index.html">tfestimators</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Using
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Getting Started</li>
    <li>
      <a href="../../articles/using_estimators.html">Using Estimators</a>
    </li>
    <li>
      <a href="../../articles/input_functions.html">Input Functions</a>
    </li>
    <li>
      <a href="../../articles/feature_columns.html">Feature Columns</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Advanced</li>
    <li>
      <a href="../../articles/experiments.html">Experiments</a>
    </li>
    <li>
      <a href="../../articles/run_hooks.html">Run Hooks</a>
    </li>
    <li>
      <a href="../../articles/custom_estimators.html">Custom Estimators</a>
    </li>
    <li>
      <a href="../../articles/tensorboard.html">TensorBoard Visualization</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../articles/examples/index.html">Examples</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/tfestimators">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>wide_and_deep.R</h1>
            
          </div>

    
    
<div class="contents">
<p>In this example, we’ll introduce how to use the TensorFlow Estimators API to jointly train a wide linear model and a deep feed-forward neural network. This approach combines the strengths of memorization and generalization. It’s useful for generic large-scale regression and classification problems with sparse input features (e.g., categorical features with a large number of possible feature values). If you’re interested in learning more about how Wide &amp; Deep Learning works, please check out the <a href="http://arxiv.org/abs/1606.07792">white paper</a>.</p>
<div id="download-data" class="section level3">
<h3 class="hasAnchor">
<a href="#download-data" class="anchor"></a>Download Data</h3>
<p>First of all, let’s download the census data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tfestimators)

maybe_download_census &lt;-<span class="st"> </span><span class="cf">function</span>(train_data_path, test_data_path, column_names_to_assign) {
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(train_data_path) <span class="op">||</span><span class="st"> </span><span class="op">!</span><span class="kw">file.exists</span>(test_data_path)) {
    <span class="kw">cat</span>(<span class="st">"Downloading census data ..."</span>)
    train_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">"https://archive.ics.uci.edu/ml/machine-learning-databases/adult/adult.data"</span>, <span class="dt">header =</span> <span class="ot">FALSE</span>, <span class="dt">skip =</span> <span class="dv">1</span>)
    test_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">"https://archive.ics.uci.edu/ml/machine-learning-databases/adult/adult.test"</span>, <span class="dt">header =</span> <span class="ot">FALSE</span>, <span class="dt">skip =</span> <span class="dv">1</span>)
    <span class="kw">colnames</span>(train_data) &lt;-<span class="st"> </span>column_names_to_assign
    <span class="kw">colnames</span>(test_data) &lt;-<span class="st"> </span>column_names_to_assign
    <span class="kw">write.csv</span>(train_data, train_data_path, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)
    <span class="kw">write.csv</span>(test_data, test_data_path, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)
  } <span class="cf">else</span> {
    train_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(train_data_path, <span class="dt">header =</span> <span class="ot">TRUE</span>)
    test_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(test_data_path, <span class="dt">header =</span> <span class="ot">TRUE</span>)
  }
  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">train_data =</span> train_data, <span class="dt">test_data =</span> test_data))
}

COLNAMES &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"age"</span>, <span class="st">"workclass"</span>, <span class="st">"fnlwgt"</span>, <span class="st">"education"</span>, <span class="st">"education_num"</span>, <span class="st">"marital_status"</span>, <span class="st">"occupation"</span>,
              <span class="st">"relationship"</span>, <span class="st">"race"</span>, <span class="st">"sex"</span>, <span class="st">"capital_gain"</span>, <span class="st">"capital_loss"</span>, <span class="st">"hours_per_week"</span>, <span class="st">"native_country"</span>,
              <span class="st">"income_bracket"</span>)

downloaded_data &lt;-<span class="st"> </span><span class="kw">maybe_download_census</span>(
  <span class="kw">file.path</span>(<span class="kw">getwd</span>(), <span class="st">"train_census.csv"</span>),
  <span class="kw">file.path</span>(<span class="kw">getwd</span>(), <span class="st">"test_census.csv"</span>),
  COLNAMES
)
train_data &lt;-<span class="st"> </span>downloaded_data<span class="op">$</span>train_data
test_data &lt;-<span class="st"> </span>downloaded_data<span class="op">$</span>test_data</code></pre></div>
</div>
<div id="define-base-feature-columns" class="section level3">
<h3 class="hasAnchor">
<a href="#define-base-feature-columns" class="anchor"></a>Define Base Feature Columns</h3>
<p>Next, let’s define the base categorical and continuous feature columns that we’ll use. These base columns will be the building blocks used by both the wide part and the deep part of the model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Categorical base columns</span>
education &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/column_categorical_with_hash_bucket.html">column_categorical_with_hash_bucket</a></span>(<span class="st">"education"</span>, <span class="dt">hash_bucket_size =</span> 1000L, <span class="dt">dtype =</span> tf<span class="op">$</span>int32)
relationship &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/column_categorical_with_hash_bucket.html">column_categorical_with_hash_bucket</a></span>(<span class="st">"relationship"</span>, <span class="dt">hash_bucket_size =</span> 100L, <span class="dt">dtype =</span> tf<span class="op">$</span>int32)
workclass &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/column_categorical_with_hash_bucket.html">column_categorical_with_hash_bucket</a></span>(<span class="st">"workclass"</span>, <span class="dt">hash_bucket_size =</span> 100L, <span class="dt">dtype =</span> tf<span class="op">$</span>int32)
occupation &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/column_categorical_with_hash_bucket.html">column_categorical_with_hash_bucket</a></span>(<span class="st">"occupation"</span>, <span class="dt">hash_bucket_size =</span> 100L, <span class="dt">dtype =</span> tf<span class="op">$</span>int32)
native_country &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/column_categorical_with_hash_bucket.html">column_categorical_with_hash_bucket</a></span>(<span class="st">"native_country"</span>, <span class="dt">hash_bucket_size =</span> 1000L, <span class="dt">dtype =</span> tf<span class="op">$</span>int32)

<span class="co"># Continuous base columns.</span>
age &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/column_numeric.html">column_numeric</a></span>(<span class="st">"age"</span>)
age_buckets &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/column_bucketized.html">column_bucketized</a></span>(age, <span class="dt">boundaries =</span> <span class="kw">list</span>(<span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">30</span>, <span class="dv">35</span>, <span class="dv">40</span>, <span class="dv">45</span>, <span class="dv">50</span>, <span class="dv">55</span>, <span class="dv">60</span>, <span class="dv">65</span>))
education_num &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/column_numeric.html">column_numeric</a></span>(<span class="st">"education_num"</span>)
capital_gain &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/column_numeric.html">column_numeric</a></span>(<span class="st">"capital_gain"</span>)
capital_loss &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/column_numeric.html">column_numeric</a></span>(<span class="st">"capital_loss"</span>)
hours_per_week &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/column_numeric.html">column_numeric</a></span>(<span class="st">"hours_per_week"</span>)</code></pre></div>
</div>
<div id="define-wide-and-deep-columns" class="section level3">
<h3 class="hasAnchor">
<a href="#define-wide-and-deep-columns" class="anchor"></a>Define Wide and Deep Columns</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wide_columns &lt;-<span class="st"> </span><span class="kw">list</span>(native_country, education, occupation, workclass, relationship, age_buckets)

deep_columns &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="kw"><a href="../../reference/column_embedding.html">column_embedding</a></span>(workclass, <span class="dt">dimension =</span> 8L),
  <span class="kw"><a href="../../reference/column_embedding.html">column_embedding</a></span>(education, <span class="dt">dimension =</span> 8L),
  <span class="kw"><a href="../../reference/column_embedding.html">column_embedding</a></span>(relationship, <span class="dt">dimension =</span> 8L),
  <span class="kw"><a href="../../reference/column_embedding.html">column_embedding</a></span>(native_country, <span class="dt">dimension =</span> 8L),
  <span class="kw"><a href="../../reference/column_embedding.html">column_embedding</a></span>(occupation, <span class="dt">dimension =</span> 8L),
  age, education_num, capital_gain, capital_loss, hours_per_week)</code></pre></div>
</div>
<div id="combining-wide-and-deep-models-into-one" class="section level3">
<h3 class="hasAnchor">
<a href="#combining-wide-and-deep-models-into-one" class="anchor"></a>Combining Wide and Deep Models into One</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/linear_dnn_combined_classifier.html">linear_dnn_combined_classifier</a></span>(
  <span class="dt">linear_feature_columns =</span> wide_columns,
  <span class="dt">dnn_feature_columns =</span> deep_columns,
  <span class="dt">dnn_hidden_units =</span> <span class="kw">c</span>(100L, 50L)
)</code></pre></div>
</div>
<div id="training-and-evaluating-the-model" class="section level3">
<h3 class="hasAnchor">
<a href="#training-and-evaluating-the-model" class="anchor"></a>Training and Evaluating The Model</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Build labels according to income bracket</span>
train_data<span class="op">$</span>income_bracket &lt;-<span class="st"> </span><span class="kw">as.character</span>(train_data<span class="op">$</span>income_bracket)
test_data<span class="op">$</span>income_bracket &lt;-<span class="st"> </span><span class="kw">as.character</span>(test_data<span class="op">$</span>income_bracket)
train_data<span class="op">$</span>label &lt;-<span class="st"> </span><span class="kw">ifelse</span>(train_data<span class="op">$</span>income_bracket <span class="op">==</span><span class="st"> " &gt;50K"</span>, <span class="dv">1</span>, <span class="dv">0</span>)
test_data<span class="op">$</span>label &lt;-<span class="st"> </span><span class="kw">ifelse</span>(test_data<span class="op">$</span>income_bracket <span class="op">==</span><span class="st"> " &gt;50K"</span>, <span class="dv">1</span>, <span class="dv">0</span>)

constructed_input_fn &lt;-<span class="st"> </span><span class="cf">function</span>(dataset) {
  <span class="kw"><a href="../../reference/input_fn.html">input_fn</a></span>(dataset, <span class="dt">features =</span> COLNAMES[<span class="op">-</span><span class="kw">length</span>(COLNAMES)], <span class="dt">response =</span> <span class="st">"label"</span>)
}
train_input_fn &lt;-<span class="st"> </span><span class="kw">constructed_input_fn</span>(train_data)
eval_input_fn &lt;-<span class="st"> </span><span class="kw">constructed_input_fn</span>(test_data)

<span class="kw">train</span>(model, <span class="dt">input_fn =</span> train_input_fn, <span class="dt">steps =</span> 2L)

<span class="kw">evaluate</span>(model, <span class="dt">input_fn =</span> eval_input_fn, <span class="dt">steps =</span> 2L)</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Yuan Tang, JJ Allaire, <a href="https://www.rstudio.com"><img src="http://tidyverse.org/rstudio-logo.svg" height="24"></a>, Kevin Ushey.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
